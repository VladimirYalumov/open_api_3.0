"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = startPreviewServer;

var _handlebars = require("handlebars");

var _chalk = _interopRequireDefault(require("chalk"));

var portfinder = _interopRequireWildcard(require("portfinder"));

var _fs = require("fs");

var path = _interopRequireWildcard(require("path"));

var _server = require("./server");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// import { watch } from 'chokidar';
function getPageHTML(htmlTemplate, redocOptions = {}, wsPort) {
  const template = (0, _handlebars.compile)((0, _fs.readFileSync)(htmlTemplate, 'utf-8'));
  return template({
    redocHead: `
  <script>
    window.__REDOC_EXPORT = '${redocOptions.licenseKey ? 'RedoclyAPIReference' : 'Redoc'}';
    window.__OPENAPI_CLI_WS_PORT = ${wsPort};
  </script>
  <script src="/simplewebsocket.min.js"></script>
  <script src="/hot.js"></script>
  <script src="${redocOptions.licenseKey ? 'https://cdn.jsdelivr.net/npm/@redocly/api-reference@latest/dist/redocly-api-reference.min.js' : 'https://cdn.jsdelivr.net/npm/redoc@latest/bundles/redoc.standalone.js'}"></script>
`,
    redocHTML: `
  <div id="redoc"></div>
  <script>
    var container = document.getElementById('redoc');
    ${redocOptions.licenseKey ? "window[window.__REDOC_EXPORT].setPublicPath('https://cdn.jsdelivr.net/npm/@redocly/api-reference@latest/dist/');" : ''}
    window[window.__REDOC_EXPORT].init("openapi.json", ${JSON.stringify(redocOptions)}, container)
  </script>`
  });
}

async function startPreviewServer(port, {
  getBundle,
  getOptions,
  htmlTemplate = path.join(__dirname, 'default.hbs')
}) {
  const handler = async (request, response) => {
    console.time(_chalk.default.dim(`GET ${request.url}`));

    if (request.url === '/') {
      (0, _server.respondWithGzip)(getPageHTML(htmlTemplate, getOptions(), wsPort), request, response, {
        'Content-Type': 'text/html'
      });
    } else if (request.url === '/openapi.json') {
      (0, _server.respondWithGzip)(JSON.stringify((await getBundle())), request, response, {
        'Content-Type': 'application/json'
      });
    } else {
      const filePath = {
        '/hot.js': path.join(__dirname, 'hot.js'),
        '/simplewebsocket.min.js': require.resolve('simple-websocket/simplewebsocket.min.js')
      }[request.url] || path.resolve(path.dirname(htmlTemplate), `.${request.url}`);
      const extname = String(path.extname(filePath)).toLowerCase();
      const contentType = _server.mimeTypes[extname] || 'application/octet-stream';

      try {
        (0, _server.respondWithGzip)((await _fs.promises.readFile(filePath, 'utf-8')), request, response, {
          'Content-Type': contentType
        });
      } catch (e) {
        if (e.code === 'ENOENT') {
          (0, _server.respondWithGzip)('404 Not Found', request, response, {
            'Content-Type': 'text/html'
          }, 404);
        } else {
          (0, _server.respondWithGzip)(`Something went wrong: ${e.code}...\n`, request, response, {}, 500);
        }
      }
    }

    console.timeEnd(_chalk.default.dim(`GET ${request.url}`));
  };

  let wsPort = await portfinder.getPortPromise({
    port: 32201
  });
  const server = (0, _server.startHttpServer)(port, handler);
  server.on('listening', () => {
    process.stdout.write(`\n  ðŸ”Ž  Preview server running at ${_chalk.default.blue(`http://127.0.0.1:${port}\n`)}`);
  });
  return (0, _server.startWsServer)(wsPort);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wcmV2aWV3LWRvY3MvaW5kZXguanMiXSwibmFtZXMiOlsiZ2V0UGFnZUhUTUwiLCJodG1sVGVtcGxhdGUiLCJyZWRvY09wdGlvbnMiLCJ3c1BvcnQiLCJ0ZW1wbGF0ZSIsInJlZG9jSGVhZCIsImxpY2Vuc2VLZXkiLCJyZWRvY0hUTUwiLCJKU09OIiwic3RyaW5naWZ5Iiwic3RhcnRQcmV2aWV3U2VydmVyIiwicG9ydCIsImdldEJ1bmRsZSIsImdldE9wdGlvbnMiLCJwYXRoIiwiam9pbiIsIl9fZGlybmFtZSIsImhhbmRsZXIiLCJyZXF1ZXN0IiwicmVzcG9uc2UiLCJjb25zb2xlIiwidGltZSIsImNoYWxrIiwiZGltIiwidXJsIiwiZmlsZVBhdGgiLCJyZXF1aXJlIiwicmVzb2x2ZSIsImRpcm5hbWUiLCJleHRuYW1lIiwiU3RyaW5nIiwidG9Mb3dlckNhc2UiLCJjb250ZW50VHlwZSIsIm1pbWVUeXBlcyIsImZzUHJvbWlzZXMiLCJyZWFkRmlsZSIsImUiLCJjb2RlIiwidGltZUVuZCIsInBvcnRmaW5kZXIiLCJnZXRQb3J0UHJvbWlzZSIsInNlcnZlciIsIm9uIiwicHJvY2VzcyIsInN0ZG91dCIsIndyaXRlIiwiYmx1ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBOztBQUNBOztBQUNBOztBQUdBOztBQUNBOztBQUVBOzs7Ozs7OztBQVRBO0FBYUEsU0FBU0EsV0FBVCxDQUFxQkMsWUFBckIsRUFBbUNDLFlBQVksR0FBRyxFQUFsRCxFQUFzREMsTUFBdEQsRUFBOEQ7QUFDNUQsUUFBTUMsUUFBUSxHQUFHLHlCQUFRLHNCQUFhSCxZQUFiLEVBQTJCLE9BQTNCLENBQVIsQ0FBakI7QUFDQSxTQUFPRyxRQUFRLENBQUM7QUFDZEMsSUFBQUEsU0FBUyxFQUFHOzsrQkFFZUgsWUFBWSxDQUFDSSxVQUFiLEdBQTBCLHFCQUExQixHQUFrRCxPQUFRO3FDQUNwREgsTUFBTzs7OztpQkFJM0JELFlBQVksQ0FBQ0ksVUFBYixHQUNYLDhGQURX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QU04QixNQUFNLEdBQUcsNkJBQWdCOUIsSUFBaEIsRUFBc0JNLE9BQXRCLENBQWY7QUFDQXdCLEVBQUFBLE1BQU0sQ0FBQ0MsRUFBUCxDQUFVLFdBQVYsRUFBdUIsTUFBTTtBQUMzQkMsSUFBQUEsT0FBTyxDQUFDQyxNQUFSLENBQWVDLEtBQWYsQ0FBc0IscUNBQW9DdkIsZUFBTXdCLElBQU4sQ0FBWSxvQkFBbUJuQyxJQUFLLElBQXBDLENBQXlDLEVBQW5HO0FBQ0QsR0FGRDtBQUlBLFNBQU8sMkJBQWNSLE1BQWQsQ0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLy8gaW1wb3J0IHsgd2F0Y2ggfSBmcm9tICdjaG9raWRhcic7XG5pbXBvcnQgeyBjb21waWxlIH0gZnJvbSAnaGFuZGxlYmFycyc7XG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnO1xuaW1wb3J0ICogYXMgcG9ydGZpbmRlciBmcm9tICdwb3J0ZmluZGVyJztcblxuXG5pbXBvcnQgeyByZWFkRmlsZVN5bmMsIHByb21pc2VzIGFzIGZzUHJvbWlzZXMgfSBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQge1xuICBzdGFydEh0dHBTZXJ2ZXIsIHN0YXJ0V3NTZXJ2ZXIsIHJlc3BvbmRXaXRoR3ppcCwgbWltZVR5cGVzLFxufSBmcm9tICcuL3NlcnZlcic7XG5cbmZ1bmN0aW9uIGdldFBhZ2VIVE1MKGh0bWxUZW1wbGF0ZSwgcmVkb2NPcHRpb25zID0ge30sIHdzUG9ydCkge1xuICBjb25zdCB0ZW1wbGF0ZSA9IGNvbXBpbGUocmVhZEZpbGVTeW5jKGh0bWxUZW1wbGF0ZSwgJ3V0Zi04JykpO1xuICByZXR1cm4gdGVtcGxhdGUoe1xuICAgIHJlZG9jSGVhZDogYFxuICA8c2NyaXB0PlxuICAgIHdpbmRvdy5fX1JFRE9DX0VYUE9SVCA9ICcke3JlZG9jT3B0aW9ucy5saWNlbnNlS2V5ID8gJ1JlZG9jbHlBUElSZWZlcmVuY2UnIDogJ1JlZG9jJ30nO1xuICAgIHdpbmRvdy5fX09QRU5BUElfQ0xJX1dTX1BPUlQgPSAke3dzUG9ydH07XG4gIDwvc2NyaXB0PlxuICA8c2NyaXB0IHNyYz1cIi9zaW1wbGV3ZWJzb2NrZXQubWluLmpzXCI+PC9zY3JpcHQ+XG4gIDxzY3JpcHQgc3JjPVwiL2hvdC5qc1wiPjwvc2NyaXB0PlxuICA8c2NyaXB0IHNyYz1cIiR7cmVkb2NPcHRpb25zLmxpY2Vuc2VLZXlcbiAgICA/ICdodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL0ByZWRvY2x5L2FwaS1yZWZlcmVuY2VAbGF0ZXN0L2Rpc3QvcmVkb2NseS1hcGktcmVmZXJlbmNlLm1pbi5qcydcbiAgICA6ICdodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL3JlZG9jQGxhdGVzdC9idW5kbGVzL3JlZG9jLnN0YW5kYWxvbmUuanMnfVwiPjwvc2NyaXB0PlxuYCxcbiAgICByZWRvY0hUTUw6IGBcbiAgPGRpdiBpZD1cInJlZG9jXCI+PC9kaXY+XG4gIDxzY3JpcHQ+XG4gICAgdmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWRvYycpO1xuICAgICR7cmVkb2NPcHRpb25zLmxpY2Vuc2VLZXkgPyBcIndpbmRvd1t3aW5kb3cuX19SRURPQ19FWFBPUlRdLnNldFB1YmxpY1BhdGgoJ2h0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vQHJlZG9jbHkvYXBpLXJlZmVyZW5jZUBsYXRlc3QvZGlzdC8nKTtcIiA6ICcnfVxuICAgIHdpbmRvd1t3aW5kb3cuX19SRURPQ19FWFBPUlRdLmluaXQoXCJvcGVuYXBpLmpzb25cIiwgJHtKU09OLnN0cmluZ2lmeShyZWRvY09wdGlvbnMpfSwgY29udGFpbmVyKVxuICA8L3NjcmlwdD5gLFxuICB9KTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgZnVuY3Rpb24gc3RhcnRQcmV2aWV3U2VydmVyKHBvcnQsIHtcbiAgZ2V0QnVuZGxlLFxuICBnZXRPcHRpb25zLFxuICBodG1sVGVtcGxhdGUgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnZGVmYXVsdC5oYnMnKSxcbn0pIHtcbiAgY29uc3QgaGFuZGxlciA9IGFzeW5jIChyZXF1ZXN0LCByZXNwb25zZSkgPT4ge1xuICAgIGNvbnNvbGUudGltZShjaGFsay5kaW0oYEdFVCAke3JlcXVlc3QudXJsfWApKTtcbiAgICBpZiAocmVxdWVzdC51cmwgPT09ICcvJykge1xuICAgICAgcmVzcG9uZFdpdGhHemlwKGdldFBhZ2VIVE1MKGh0bWxUZW1wbGF0ZSwgZ2V0T3B0aW9ucygpLCB3c1BvcnQpLCByZXF1ZXN0LCByZXNwb25zZSwge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ3RleHQvaHRtbCcsXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKHJlcXVlc3QudXJsID09PSAnL29wZW5hcGkuanNvbicpIHtcbiAgICAgIHJlc3BvbmRXaXRoR3ppcChKU09OLnN0cmluZ2lmeShhd2FpdCBnZXRCdW5kbGUoKSksIHJlcXVlc3QsIHJlc3BvbnNlLCB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZmlsZVBhdGggPSB7XG4gICAgICAgICcvaG90LmpzJzogcGF0aC5qb2luKF9fZGlybmFtZSwgJ2hvdC5qcycpLFxuICAgICAgICAnL3NpbXBsZXdlYnNvY2tldC5taW4uanMnOiByZXF1aXJlLnJlc29sdmUoJ3NpbXBsZS13ZWJzb2NrZXQvc2ltcGxld2Vic29ja2V0Lm1pbi5qcycpLFxuICAgICAgfVtyZXF1ZXN0LnVybF0gfHwgcGF0aC5yZXNvbHZlKHBhdGguZGlybmFtZShodG1sVGVtcGxhdGUpLCBgLiR7cmVxdWVzdC51cmx9YCk7XG5cbiAgICAgIGNvbnN0IGV4dG5hbWUgPSBTdHJpbmcocGF0aC5leHRuYW1lKGZpbGVQYXRoKSkudG9Mb3dlckNhc2UoKTtcblxuICAgICAgY29uc3QgY29udGVudFR5cGUgPSBtaW1lVHlwZXNbZXh0bmFtZV0gfHwgJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSc7XG4gICAgICB0cnkge1xuICAgICAgICByZXNwb25kV2l0aEd6aXAoYXdhaXQgZnNQcm9taXNlcy5yZWFkRmlsZShmaWxlUGF0aCwgJ3V0Zi04JyksIHJlcXVlc3QsIHJlc3BvbnNlLCB7XG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6IGNvbnRlbnRUeXBlLFxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKGUuY29kZSA9PT0gJ0VOT0VOVCcpIHtcbiAgICAgICAgICByZXNwb25kV2l0aEd6aXAoJzQwNCBOb3QgRm91bmQnLCByZXF1ZXN0LCByZXNwb25zZSwgeyAnQ29udGVudC1UeXBlJzogJ3RleHQvaHRtbCcgfSwgNDA0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXNwb25kV2l0aEd6aXAoYFNvbWV0aGluZyB3ZW50IHdyb25nOiAke2UuY29kZX0uLi5cXG5gLCByZXF1ZXN0LCByZXNwb25zZSwge30sIDUwMCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgY29uc29sZS50aW1lRW5kKGNoYWxrLmRpbShgR0VUICR7cmVxdWVzdC51cmx9YCkpO1xuICB9O1xuXG4gIGxldCB3c1BvcnQgPSBhd2FpdCBwb3J0ZmluZGVyLmdldFBvcnRQcm9taXNlKHsgcG9ydDogMzIyMDEgfSk7XG5cbiAgY29uc3Qgc2VydmVyID0gc3RhcnRIdHRwU2VydmVyKHBvcnQsIGhhbmRsZXIpO1xuICBzZXJ2ZXIub24oJ2xpc3RlbmluZycsICgpID0+IHtcbiAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShgXFxuICDwn5SOICBQcmV2aWV3IHNlcnZlciBydW5uaW5nIGF0ICR7Y2hhbGsuYmx1ZShgaHR0cDovLzEyNy4wLjAuMToke3BvcnR9XFxuYCl9YCk7XG4gIH0pO1xuXG4gIHJldHVybiBzdGFydFdzU2VydmVyKHdzUG9ydCk7XG59XG4iXX0=