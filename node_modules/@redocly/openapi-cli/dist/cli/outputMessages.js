"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.outputMessages = exports.prettyPrintShort = exports.printValidationHeader = exports.prettyPrint = void 0;

var _path = _interopRequireDefault(require("path"));

var _chalk = _interopRequireDefault(require("chalk"));

var _utils = require("../utils");

var _default = require("../error/default");

var _groupMessages = require("./groupMessages");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const colorizeMessageHeader = (msg, longestPath) => {
  const msgHeader = `${_path.default.relative(process.cwd(), msg.file)}:${msg.location.startLine}:${msg.location.startCol}`;

  switch (msg.severity) {
    case _default.messageLevels.ERROR:
      return (0, _utils.outputBgRed)((0, _utils.outputBgRed)(msgHeader.padEnd(longestPath + 2 - 20)));

    case _default.messageLevels.WARNING:
      return (0, _utils.outputBgYellow)((0, _utils.outputRed)(msgHeader.padEnd(longestPath + 2 - 20)));

    case _default.messageLevels.INFO:
      return (0, _utils.outputBgLightBlue)((0, _utils.outputRed)(msgHeader.padEnd(longestPath + 2 - 20)));

    default:
      return msgHeader;
  }
};

const colorizeRuleName = (error, severity) => {
  switch (severity) {
    case _default.messageLevels.ERROR:
      return (0, _utils.outputRed)(error);

    case _default.messageLevels.WARNING:
      return (0, _utils.outputYellow)(error);

    case _default.messageLevels.INFO:
      return (0, _utils.outputBgLightBlue)(error);

    default:
      return error;
  }
};

const pathImproveReadability = msgPath => msgPath.map(el => el[0] === '/' ? (0, _utils.outputGrey)('[\'') + (0, _utils.outputLightBlue)(el) + (0, _utils.outputGrey)('\']') : (0, _utils.outputGrey)(el));

const prettifyReferencedFrom = row => `${(0, _utils.outputLightBlue)(`${row.file}:${row.startLine}`)} ${(0, _utils.outputGrey)(`#/${pathImproveReadability(row.path).join((0, _utils.outputGrey)('/'))}`)}`;

const renderReferencedFrom = (referencedFromPlaces, severity) => {
  if (referencedFromPlaces.length === 0) return '';
  return `This ${severity.toLowerCase()} is referenced from:\n${referencedFromPlaces.map((row, id) => `${id + 1}) ${prettifyReferencedFrom(row)}`).join('\n')}`;
};

const getMsgSeverity = msg => {
  switch (msg.severity) {
    case _default.messageLevels.WARNING:
      return 'Warning';

    case _default.messageLevels.ERROR:
    default:
      return 'Error';
  }
};

const prettyPrint = (i, error) => {
  const {
    possibleAlternate
  } = error;
  const message = `[${i}] ${colorizeMessageHeader(error)} ${(0, _utils.outputGrey)(`at #/${(0, _utils.outputGrey)(pathImproveReadability(error.path).join((0, _utils.outputGrey)('/')))}`)}` + `\n${error.message}\n` + `${possibleAlternate && possibleAlternate.possibleAlternate ? `\nDid you mean: ${(0, _utils.outputLightBlue)(possibleAlternate.possibleAlternate)} ?\n` : ''}` + `${error.enableCodeframe ? `\n${error.codeFrame}\n\n` : ''}` + `${error.fromRule ? `${getMsgSeverity(error)} was generated by ${_chalk.default.red(error.fromRule)} rule.\n\n` : ''}` + `${renderReferencedFrom(error.referencedFromPlaces, getMsgSeverity(error))}` + '\n\n';
  return message;
};

exports.prettyPrint = prettyPrint;

const printValidationHeader = _filePath => {// nope for now [Roman]
  // well, at least I've tried. Not a designer, for sure [Sergey]
};

exports.printValidationHeader = printValidationHeader;

const prettyPrintShort = (i, error, longestPath, longestRuleName) => {
  const message = `${`${error.location.startLine}:${error.location.startCol}`.padEnd(longestPath)} ${colorizeRuleName(error.fromRule.padEnd(longestRuleName + 2), error.severity)} ${error.message}\n`;
  return message;
};

exports.prettyPrintShort = prettyPrintShort;

const outputMessages = (result, cmdObj) => {
  const errorsGrouped = (0, _groupMessages.groupErrors)(result);
  const groupedByFile = (0, _groupMessages.groupByFiles)(errorsGrouped);
  const totalErrors = errorsGrouped.filter(msg => msg.severity === _default.messageLevels.ERROR).length;
  const totalWarnings = errorsGrouped.filter(msg => msg.severity === _default.messageLevels.WARNING).length;

  if (cmdObj.short && errorsGrouped.length !== 0) {
    const posLength = errorsGrouped.map(msg => `${msg.location.startLine}:${msg.location.startCol}`).sort((e, o) => e.length > o.length).pop().length;
    const longestRuleName = errorsGrouped.map(msg => msg.fromRule).sort((e, o) => e.length > o.length).pop().length;
    Object.keys(groupedByFile).forEach(fileName => {
      process.stderr.write(`${(0, _utils.outputUnderline)(`${_path.default.relative(process.cwd(), fileName)}:\n`)}`);
      groupedByFile[fileName].sort((a, b) => a.severity < b.severity).forEach((entry, id) => process.stderr.write(prettyPrintShort(id + 1, entry, posLength, longestRuleName)));
      process.stderr.write('\n');
    });
  } else {
    if (errorsGrouped.length > 0) process.stderr.write('\n\n');
    errorsGrouped.sort((a, b) => a.severity < b.severity).forEach((entry, id) => process.stderr.write(prettyPrint(id + 1, entry)));
  }

  return {
    totalErrors,
    totalWarnings
  };
};

exports.outputMessages = outputMessages;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvb3V0cHV0TWVzc2FnZXMuanMiXSwibmFtZXMiOlsiY29sb3JpemVNZXNzYWdlSGVhZGVyIiwibXNnIiwibG9uZ2VzdFBhdGgiLCJtc2dIZWFkZXIiLCJwYXRoIiwicmVsYXRpdmUiLCJwcm9jZXNzIiwiY3dkIiwiZmlsZSIsImxvY2F0aW9uIiwic3RhcnRMaW5lIiwic3RhcnRDb2wiLCJzZXZlcml0eSIsIm1lc3NhZ2VMZXZlbHMiLCJFUlJPUiIsInBhZEVuZCIsIldBUk5JTkciLCJJTkZPIiwiY29sb3JpemVSdWxlTmFtZSIsImVycm9yIiwicGF0aEltcHJvdmVSZWFkYWJpbGl0eSIsIm1zZ1BhdGgiLCJtYXAiLCJlbCIsInByZXR0aWZ5UmVmZXJlbmNlZEZyb20iLCJyb3ciLCJqb2luIiwicmVuZGVyUmVmZXJlbmNlZEZyb20iLCJyZWZlcmVuY2VkRnJvbVBsYWNlcyIsImxlbmd0aCIsInRvTG93ZXJDYXNlIiwiaWQiLCJnZXRNc2dTZXZlcml0eSIsInByZXR0eVByaW50IiwiaSIsInBvc3NpYmxlQWx0ZXJuYXRlIiwibWVzc2FnZSIsImVuYWJsZUNvZGVmcmFtZSIsImNvZGVGcmFtZSIsImZyb21SdWxlIiwiY2hhbGsiLCJyZWQiLCJwcmludFZhbGlkYXRpb25IZWFkZXIiLCJfZmlsZVBhdGgiLCJwcmV0dHlQcmludFNob3J0IiwibG9uZ2VzdFJ1bGVOYW1lIiwib3V0cHV0TWVzc2FnZXMiLCJyZXN1bHQiLCJjbWRPYmoiLCJlcnJvcnNHcm91cGVkIiwiZ3JvdXBlZEJ5RmlsZSIsInRvdGFsRXJyb3JzIiwiZmlsdGVyIiwidG90YWxXYXJuaW5ncyIsInNob3J0IiwicG9zTGVuZ3RoIiwic29ydCIsImUiLCJvIiwicG9wIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJmaWxlTmFtZSIsInN0ZGVyciIsIndyaXRlIiwiYSIsImIiLCJlbnRyeSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztBQVdBOztB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QmhCLElBQUFBLGFBQWEsQ0FDVk8sSUFESCxDQUNRLENBQUNVLENBQUQsRUFBSUMsQ0FBSixLQUFVRCxDQUFDLENBQUN0RCxRQUFGLEdBQWF1RCxDQUFDLENBQUN2RCxRQURqQyxFQUVHa0QsT0FGSCxDQUVXLENBQUNNLEtBQUQsRUFBUXJDLEVBQVIsS0FBZXpCLE9BQU8sQ0FBQzBELE1BQVIsQ0FBZUMsS0FBZixDQUFxQmhDLFdBQVcsQ0FBQ0YsRUFBRSxHQUFHLENBQU4sRUFBU3FDLEtBQVQsQ0FBaEMsQ0FGMUI7QUFHRDs7QUFFRCxTQUFPO0FBQ0xqQixJQUFBQSxXQURLO0FBRUxFLElBQUFBO0FBRkssR0FBUDtBQUlELENBOUNNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnO1xuXG5pbXBvcnQge1xuICBvdXRwdXRMaWdodEJsdWUsXG4gIG91dHB1dEJnUmVkLFxuICBvdXRwdXRHcmV5LFxuICBvdXRwdXRCZ1llbGxvdyxcbiAgb3V0cHV0UmVkLFxuICBvdXRwdXRCZ0xpZ2h0Qmx1ZSxcbiAgb3V0cHV0WWVsbG93LFxuICBvdXRwdXRVbmRlcmxpbmUsXG59IGZyb20gJy4uL3V0aWxzJztcblxuaW1wb3J0IHsgbWVzc2FnZUxldmVscyB9IGZyb20gJy4uL2Vycm9yL2RlZmF1bHQnO1xuXG5pbXBvcnQgeyBncm91cEJ5RmlsZXMsIGdyb3VwRXJyb3JzIH0gZnJvbSAnLi9ncm91cE1lc3NhZ2VzJztcblxuY29uc3QgY29sb3JpemVNZXNzYWdlSGVhZGVyID0gKG1zZywgbG9uZ2VzdFBhdGgpID0+IHtcbiAgY29uc3QgbXNnSGVhZGVyID0gYCR7cGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCBtc2cuZmlsZSl9OiR7bXNnLmxvY2F0aW9uLnN0YXJ0TGluZX06JHttc2cubG9jYXRpb24uc3RhcnRDb2x9YDtcbiAgc3dpdGNoIChtc2cuc2V2ZXJpdHkpIHtcbiAgICBjYXNlIG1lc3NhZ2VMZXZlbHMuRVJST1I6XG4gICAgICByZXR1cm4gb3V0cHV0QmdSZWQob3V0cHV0QmdSZWQobXNnSGVhZGVyLnBhZEVuZChsb25nZXN0UGF0aCArIDIgLSAyMCkpKTtcbiAgICBjYXNlIG1lc3NhZ2VMZXZlbHMuV0FSTklORzpcbiAgICAgIHJldHVybiBvdXRwdXRCZ1llbGxvdyhvdXRwdXRSZWQobXNnSGVhZGVyLnBhZEVuZChsb25nZXN0UGF0aCArIDIgLSAyMCkpKTtcbiAgICBjYXNlIG1lc3NhZ2VMZXZlbHMuSU5GTzpcbiAgICAgIHJldHVybiBvdXRwdXRCZ0xpZ2h0Qmx1ZShvdXRwdXRSZWQobXNnSGVhZGVyLnBhZEVuZChsb25nZXN0UGF0aCArIDIgLSAyMCkpKTtcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIG1zZ0hlYWRlcjtcbiAgfVxufTtcblxuY29uc3QgY29sb3JpemVSdWxlTmFtZSA9IChlcnJvciwgc2V2ZXJpdHkpID0+IHtcbiAgc3dpdGNoIChzZXZlcml0eSkge1xuICAgIGNhc2UgbWVzc2FnZUxldmVscy5FUlJPUjpcbiAgICAgIHJldHVybiBvdXRwdXRSZWQoZXJyb3IpO1xuICAgIGNhc2UgbWVzc2FnZUxldmVscy5XQVJOSU5HOlxuICAgICAgcmV0dXJuIG91dHB1dFllbGxvdyhlcnJvcik7XG4gICAgY2FzZSBtZXNzYWdlTGV2ZWxzLklORk86XG4gICAgICByZXR1cm4gb3V0cHV0QmdMaWdodEJsdWUoZXJyb3IpO1xuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gZXJyb3I7XG4gIH1cbn07XG5cblxuY29uc3QgcGF0aEltcHJvdmVSZWFkYWJpbGl0eSA9IChtc2dQYXRoKSA9PiBtc2dQYXRoLm1hcCgoZWwpID0+IChlbFswXSA9PT0gJy8nID8gb3V0cHV0R3JleSgnW1xcJycpICsgb3V0cHV0TGlnaHRCbHVlKGVsKSArIG91dHB1dEdyZXkoJ1xcJ10nKSA6IG91dHB1dEdyZXkoZWwpKSk7XG5jb25zdCBwcmV0dGlmeVJlZmVyZW5jZWRGcm9tID0gKHJvdykgPT4gYCR7b3V0cHV0TGlnaHRCbHVlKGAke3Jvdy5maWxlfToke3Jvdy5zdGFydExpbmV9YCl9ICR7b3V0cHV0R3JleShgIy8ke3BhdGhJbXByb3ZlUmVhZGFiaWxpdHkocm93LnBhdGgpLmpvaW4ob3V0cHV0R3JleSgnLycpKX1gKX1gO1xuXG5jb25zdCByZW5kZXJSZWZlcmVuY2VkRnJvbSA9IChyZWZlcmVuY2VkRnJvbVBsYWNlcywgc2V2ZXJpdHkpID0+IHtcbiAgaWYgKHJlZmVyZW5jZWRGcm9tUGxhY2VzLmxlbmd0aCA9PT0gMCkgcmV0dXJuICcnO1xuICByZXR1cm4gYFRoaXMgJHtzZXZlcml0eS50b0xvd2VyQ2FzZSgpfSBpcyByZWZlcmVuY2VkIGZyb206XFxuJHtyZWZlcmVuY2VkRnJvbVBsYWNlcy5tYXAoKHJvdywgaWQpID0+IGAke2lkICsgMX0pICR7cHJldHRpZnlSZWZlcmVuY2VkRnJvbShyb3cpfWApLmpvaW4oJ1xcbicpfWA7XG59O1xuXG5jb25zdCBnZXRNc2dTZXZlcml0eSA9IChtc2cpID0+IHtcbiAgc3dpdGNoIChtc2cuc2V2ZXJpdHkpIHtcbiAgICBjYXNlIG1lc3NhZ2VMZXZlbHMuV0FSTklORzpcbiAgICAgIHJldHVybiAnV2FybmluZyc7XG4gICAgY2FzZSBtZXNzYWdlTGV2ZWxzLkVSUk9SOlxuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gJ0Vycm9yJztcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IHByZXR0eVByaW50ID0gKGksIGVycm9yKSA9PiB7XG4gIGNvbnN0IHsgcG9zc2libGVBbHRlcm5hdGUgfSA9IGVycm9yO1xuICBjb25zdCBtZXNzYWdlID0gYFske2l9XSAke2NvbG9yaXplTWVzc2FnZUhlYWRlcihlcnJvcil9ICR7b3V0cHV0R3JleShgYXQgIy8ke291dHB1dEdyZXkocGF0aEltcHJvdmVSZWFkYWJpbGl0eShlcnJvci5wYXRoKS5qb2luKG91dHB1dEdyZXkoJy8nKSkpfWApfWBcbiAgKyBgXFxuJHtlcnJvci5tZXNzYWdlfVxcbmBcbiAgKyBgJHtwb3NzaWJsZUFsdGVybmF0ZSAmJiBwb3NzaWJsZUFsdGVybmF0ZS5wb3NzaWJsZUFsdGVybmF0ZSA/IGBcXG5EaWQgeW91IG1lYW46ICR7b3V0cHV0TGlnaHRCbHVlKHBvc3NpYmxlQWx0ZXJuYXRlLnBvc3NpYmxlQWx0ZXJuYXRlKX0gP1xcbmAgOiAnJ31gXG4gICsgYCR7ZXJyb3IuZW5hYmxlQ29kZWZyYW1lID8gYFxcbiR7ZXJyb3IuY29kZUZyYW1lfVxcblxcbmAgOiAnJ31gXG4gICsgYCR7ZXJyb3IuZnJvbVJ1bGUgPyBgJHtnZXRNc2dTZXZlcml0eShlcnJvcil9IHdhcyBnZW5lcmF0ZWQgYnkgJHtjaGFsay5yZWQoZXJyb3IuZnJvbVJ1bGUpfSBydWxlLlxcblxcbmAgOiAnJ31gXG4gICsgYCR7cmVuZGVyUmVmZXJlbmNlZEZyb20oZXJyb3IucmVmZXJlbmNlZEZyb21QbGFjZXMsIGdldE1zZ1NldmVyaXR5KGVycm9yKSl9YFxuICArICdcXG5cXG4nO1xuICByZXR1cm4gbWVzc2FnZTtcbn07XG5cbmV4cG9ydCBjb25zdCBwcmludFZhbGlkYXRpb25IZWFkZXIgPSAoX2ZpbGVQYXRoKSA9PiB7XG4gIC8vIG5vcGUgZm9yIG5vdyBbUm9tYW5dXG4gIC8vIHdlbGwsIGF0IGxlYXN0IEkndmUgdHJpZWQuIE5vdCBhIGRlc2lnbmVyLCBmb3Igc3VyZSBbU2VyZ2V5XVxufTtcblxuZXhwb3J0IGNvbnN0IHByZXR0eVByaW50U2hvcnQgPSAoaSwgZXJyb3IsIGxvbmdlc3RQYXRoLCBsb25nZXN0UnVsZU5hbWUpID0+IHtcbiAgY29uc3QgbWVzc2FnZSA9IGAkeyhgJHtlcnJvci5sb2NhdGlvbi5zdGFydExpbmV9OiR7ZXJyb3IubG9jYXRpb24uc3RhcnRDb2x9YCkucGFkRW5kKGxvbmdlc3RQYXRoKX0gJHtjb2xvcml6ZVJ1bGVOYW1lKGVycm9yLmZyb21SdWxlLnBhZEVuZChsb25nZXN0UnVsZU5hbWUgKyAyKSwgZXJyb3Iuc2V2ZXJpdHkpfSAke2Vycm9yLm1lc3NhZ2V9XFxuYDtcbiAgcmV0dXJuIG1lc3NhZ2U7XG59O1xuXG5leHBvcnQgY29uc3Qgb3V0cHV0TWVzc2FnZXMgPSAocmVzdWx0LCBjbWRPYmopID0+IHtcbiAgY29uc3QgZXJyb3JzR3JvdXBlZCA9IGdyb3VwRXJyb3JzKHJlc3VsdCk7XG4gIGNvbnN0IGdyb3VwZWRCeUZpbGUgPSBncm91cEJ5RmlsZXMoZXJyb3JzR3JvdXBlZCk7XG5cbiAgY29uc3QgdG90YWxFcnJvcnMgPSBlcnJvcnNHcm91cGVkLmZpbHRlcihcbiAgICAobXNnKSA9PiBtc2cuc2V2ZXJpdHkgPT09IG1lc3NhZ2VMZXZlbHMuRVJST1IsXG4gICkubGVuZ3RoO1xuICBjb25zdCB0b3RhbFdhcm5pbmdzID0gZXJyb3JzR3JvdXBlZC5maWx0ZXIoXG4gICAgKG1zZykgPT4gbXNnLnNldmVyaXR5ID09PSBtZXNzYWdlTGV2ZWxzLldBUk5JTkcsXG4gICkubGVuZ3RoO1xuXG4gIGlmIChjbWRPYmouc2hvcnQgJiYgZXJyb3JzR3JvdXBlZC5sZW5ndGggIT09IDApIHtcbiAgICBjb25zdCBwb3NMZW5ndGggPSBlcnJvcnNHcm91cGVkXG4gICAgICAubWFwKChtc2cpID0+IGAke21zZy5sb2NhdGlvbi5zdGFydExpbmV9OiR7bXNnLmxvY2F0aW9uLnN0YXJ0Q29sfWApXG4gICAgICAuc29ydCgoZSwgbykgPT4gZS5sZW5ndGggPiBvLmxlbmd0aClcbiAgICAgIC5wb3AoKVxuICAgICAgLmxlbmd0aDtcblxuICAgIGNvbnN0IGxvbmdlc3RSdWxlTmFtZSA9IGVycm9yc0dyb3VwZWRcbiAgICAgIC5tYXAoKG1zZykgPT4gbXNnLmZyb21SdWxlKVxuICAgICAgLnNvcnQoKGUsIG8pID0+IGUubGVuZ3RoID4gby5sZW5ndGgpXG4gICAgICAucG9wKClcbiAgICAgIC5sZW5ndGg7XG5cbiAgICBPYmplY3Qua2V5cyhncm91cGVkQnlGaWxlKS5mb3JFYWNoKChmaWxlTmFtZSkgPT4ge1xuICAgICAgcHJvY2Vzcy5zdGRlcnIud3JpdGUoYCR7b3V0cHV0VW5kZXJsaW5lKGAke3BhdGgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgZmlsZU5hbWUpfTpcXG5gKX1gKTtcbiAgICAgIGdyb3VwZWRCeUZpbGVbZmlsZU5hbWVdXG4gICAgICAgIC5zb3J0KChhLCBiKSA9PiBhLnNldmVyaXR5IDwgYi5zZXZlcml0eSlcbiAgICAgICAgLmZvckVhY2goXG4gICAgICAgICAgKGVudHJ5LCBpZCkgPT4gcHJvY2Vzcy5zdGRlcnIud3JpdGUoXG4gICAgICAgICAgICBwcmV0dHlQcmludFNob3J0KGlkICsgMSwgZW50cnksIHBvc0xlbmd0aCwgbG9uZ2VzdFJ1bGVOYW1lKSxcbiAgICAgICAgICApLFxuICAgICAgICApO1xuICAgICAgcHJvY2Vzcy5zdGRlcnIud3JpdGUoJ1xcbicpO1xuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIGlmIChlcnJvcnNHcm91cGVkLmxlbmd0aCA+IDApIHByb2Nlc3Muc3RkZXJyLndyaXRlKCdcXG5cXG4nKTtcbiAgICBlcnJvcnNHcm91cGVkXG4gICAgICAuc29ydCgoYSwgYikgPT4gYS5zZXZlcml0eSA8IGIuc2V2ZXJpdHkpXG4gICAgICAuZm9yRWFjaCgoZW50cnksIGlkKSA9PiBwcm9jZXNzLnN0ZGVyci53cml0ZShwcmV0dHlQcmludChpZCArIDEsIGVudHJ5KSkpO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICB0b3RhbEVycm9ycyxcbiAgICB0b3RhbFdhcm5pbmdzLFxuICB9O1xufTtcbiJdfQ==