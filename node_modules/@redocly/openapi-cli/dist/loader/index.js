"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.loadRulesetExtension = loadRulesetExtension;
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("fs"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable no-underscore-dangle */
const get = (p, o) => p.reduce((xs, x) => xs && xs[x] ? xs[x] : null, o);

function getObjByPathOrParent(json, JSONPath) {
  const value = get(JSONPath.split('.'), json);

  switch (typeof value) {
    case 'string':
      return {
        level: value
      };

    case 'object':
    default:
      return {
        level: 4,
        ...value
      };
  }
}

function loadRuleset(config) {
  const ruleSet = [];
  const allRules = [];
  const configCopy = { ...config,
    rulesPath: config.rulesPath ? config.rulesPath : `${__dirname}/../visitors`
  };

  let rulesDirectory = _path.default.resolve(configCopy.rulesPath);

  if (!_fs.default.existsSync(rulesDirectory)) {
    rulesDirectory = `${__dirname}/../visitors`;
  }

  const ruleSetDirContents = _fs.default.readdirSync(rulesDirectory).map(fName => `${rulesDirectory}/${fName}`);

  const files = ruleSetDirContents.filter(fName => _fs.default.lstatSync(fName).isFile());
  const dirs = ruleSetDirContents.filter(fName => !_fs.default.lstatSync(fName).isFile() && fName.indexOf('utils') === -1);
  files.forEach(file => {
    const Rule = require(file);

    const ruleConfig = getObjByPathOrParent(configCopy.rules, Rule.rule) || {
      level: 4
    };
    const ruleInstance = new Rule(ruleConfig);

    if (ruleConfig.level !== 'off') {
      if (!ruleInstance.config) {
        ruleInstance.config = ruleConfig;
      }

      ruleInstance._config = ruleConfig;
      ruleSet.push(ruleInstance);
    }

    allRules.push(ruleInstance);
  });
  dirs.forEach(dir => {
    const [nestedRules, allNestedRules] = loadRuleset({ ...configCopy,
      rulesPath: dir
    });
    ruleSet.push(...nestedRules);
    allRules.push(...allNestedRules);
  });
  return [ruleSet, allRules];
}

function loadRulesetExtension(config, rulesetName) {
  const additionalRules = [];
  const configCopy = { ...config,
    rulesPath: config.rulesPath ? config.rulesPath : `${__dirname}/../visitors`
  };
  config[rulesetName].forEach(Rule => {
    const ruleConfig = getObjByPathOrParent(configCopy.rules, Rule.rule) || {
      level: 4
    };

    if (ruleConfig.level !== 'off') {
      const ruleInstance = new Rule(ruleConfig);

      if (!ruleInstance.config) {
        ruleInstance.config = ruleConfig;
      }

      ruleInstance._config = ruleConfig;
      additionalRules.push(ruleInstance);
    }
  });
  return additionalRules;
}

var _default = loadRuleset;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sb2FkZXIvaW5kZXguanMiXSwibmFtZXMiOlsiZ2V0IiwicCIsIm8iLCJyZWR1Y2UiLCJ4cyIsIngiLCJnZXRPYmpCeVBhdGhPclBhcmVudCIsImpzb24iLCJKU09OUGF0aCIsInZhbHVlIiwic3BsaXQiLCJsZXZlbCIsImxvYWRSdWxlc2V0IiwiY29uZmlnIiwicnVsZVNldCIsImFsbFJ1bGVzIiwiY29uZmlnQ29weSIsInJ1bGVzUGF0aCIsIl9fZGlybmFtZSIsInJ1bGVzRGlyZWN0b3J5IiwicGF0aCIsInJlc29sdmUiLCJmcyIsImV4aXN0c1N5bmMiLCJydWxlU2V0RGlyQ29udGVudHMiLCJyZWFkZGlyU3luYyIsIm1hcCIsImZOYW1lIiwiZmlsZXMiLCJmaWx0ZXIiLCJsc3RhdFN5bmMiLCJpc0ZpbGUiLCJkaXJzIiwiaW5kZXhPZiIsImZvckVhY2giLCJmaWxlIiwiUnVsZSIsInJlcXVpcmUiLCJydWxlQ29uZmlnIiwicnVsZXMiLCJydWxlIiwicnVsZUluc3RhbmNlIiwiX2NvbmZpZyIsInB1c2giLCJkaXIiLCJuZXN0ZWRSdWxlcyIsImFsbE5lc3RlZFJ1bGVzIiwibG9hZFJ1bGVzZXRFeHRlbnNpb24iLCJydWxlc2V0TmFtZSIsImFkZGl0aW9uYWxSdWxlcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFDQTs7QUFDQTs7OztBQUZBO0FBSUEsTUFBTUEsR0FBRyxHQUFHLENBQUNDLENBQUQsRUFBSUMsQ0FBSixLQUFVRCxDQUFDLENBQUNFLE1BQUYsQ0FBUyxDQUFDQyxFQUFELEVBQUtDLENBQUwsS0FBYUQsRUFBRSxJQUFJQSxFQUFFLENBQUNDLENBQUQsQ0FBVCxHQUFnQkQsRUFBRSxDQUFDQyxDQUFELENBQWxCLEdBQXdCLElBQTdDLEVBQW9ESCxDQUFwRCxDQUF0Qjs7QUFFQSxTQUFTSSxvQkFBVCxDQUE4QkMsSUFBOUIsRUFBb0NDLFFBQXBDLEVBQThDO0FBQzVDLFFBQU1DLEtBQUssR0FBR1QsR0FBRyxDQUFDUSxRQUFR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QUFWLENBQVA7QUFDRDs7QUFFTSxTQUFTZ0Msb0JBQVQsQ0FBOEJsQyxNQUE5QixFQUFzQ21DLFdBQXRDLEVBQW1EO0FBQ3hELFFBQU1DLGVBQWUsR0FBRyxFQUF4QjtBQUVBLFFBQU1qQyxVQUFVLEdBQUcsRUFDakIsR0FBR0gsTUFEYztBQUVqQkksSUFBQUEsU0FBUyxFQUFFSixNQUFNLENBQUNJLFNBQVAsR0FBbUJKLE1BQU0sQ0FBQ0ksU0FBMUIsR0FBdUMsR0FBRUMsU0FBVTtBQUY3QyxHQUFuQjtBQUtBTCxFQUFBQSxNQUFNLENBQUNtQyxXQUFELENBQU4sQ0FBb0JkLE9BQXBCLENBQTZCRSxJQUFELElBQVU7QUFDcEMsVUFBTUUsVUFBVSxHQUFHaEMsb0JBQW9CLENBQUNVLFVBQVUsQ0FBQ3VCLEtBQVosRUFBbUJILElBQUksQ0FBQ0ksSUFBeEIsQ0FBcEIsSUFBcUQ7QUFBRTdCLE1BQUFBLEtBQUssRUFBRTtBQUFULEtBQXhFOztBQUVBLFFBQUkyQixVQUFVLENBQUMzQixLQUFYLEtBQXFCLEtBQXpCLEVBQWdDO0FBQzlCLFlBQU04QixZQUFZLEdBQUcsSUFBSUwsSUFBSixDQUFTRSxVQUFULENBQXJCOztBQUNBLFVBQUksQ0FBQ0csWUFBWSxDQUFDNUIsTUFBbEIsRUFBMEI7QUFDeEI0QixRQUFBQSxZQUFZLENBQUM1QixNQUFiLEdBQXNCeUIsVUFBdEI7QUFDRDs7QUFDREcsTUFBQUEsWUFBWSxDQUFDQyxPQUFiLEdBQXVCSixVQUF2QjtBQUNBVyxNQUFBQSxlQUFlLENBQUNOLElBQWhCLENBQXFCRixZQUFyQjtBQUNEO0FBQ0YsR0FYRDtBQVlBLFNBQU9RLGVBQVA7QUFDRDs7ZUFFY3JDLFciLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby11bmRlcnNjb3JlLWRhbmdsZSAqL1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuXG5jb25zdCBnZXQgPSAocCwgbykgPT4gcC5yZWR1Y2UoKHhzLCB4KSA9PiAoKHhzICYmIHhzW3hdKSA/IHhzW3hdIDogbnVsbCksIG8pO1xuXG5mdW5jdGlvbiBnZXRPYmpCeVBhdGhPclBhcmVudChqc29uLCBKU09OUGF0aCkge1xuICBjb25zdCB2YWx1ZSA9IGdldChKU09OUGF0aC5zcGxpdCgnLicpLCBqc29uKTtcbiAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHtcbiAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbGV2ZWw6IHZhbHVlLFxuICAgICAgfTtcbiAgICBjYXNlICdvYmplY3QnOlxuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4ge1xuICAgICAgICBsZXZlbDogNCxcbiAgICAgICAgLi4udmFsdWUsXG4gICAgICB9O1xuICB9XG59XG5cbmZ1bmN0aW9uIGxvYWRSdWxlc2V0KGNvbmZpZykge1xuICBjb25zdCBydWxlU2V0ID0gW107XG4gIGNvbnN0IGFsbFJ1bGVzID0gW107XG5cbiAgY29uc3QgY29uZmlnQ29weSA9IHtcbiAgICAuLi5jb25maWcsXG4gICAgcnVsZXNQYXRoOiBjb25maWcucnVsZXNQYXRoID8gY29uZmlnLnJ1bGVzUGF0aCA6IGAke19fZGlybmFtZX0vLi4vdmlzaXRvcnNgLFxuICB9O1xuICBsZXQgcnVsZXNEaXJlY3RvcnkgPSBwYXRoLnJlc29sdmUoY29uZmlnQ29weS5ydWxlc1BhdGgpO1xuICBpZiAoIWZzLmV4aXN0c1N5bmMocnVsZXNEaXJlY3RvcnkpKSB7XG4gICAgcnVsZXNEaXJlY3RvcnkgPSBgJHtfX2Rpcm5hbWV9Ly4uL3Zpc2l0b3JzYDtcbiAgfVxuICBjb25zdCBydWxlU2V0RGlyQ29udGVudHMgPSBmcy5yZWFkZGlyU3luYyhydWxlc0RpcmVjdG9yeSlcbiAgICAubWFwKChmTmFtZSkgPT4gYCR7cnVsZXNEaXJlY3Rvcnl9LyR7Zk5hbWV9YCk7XG4gIGNvbnN0IGZpbGVzID0gcnVsZVNldERpckNvbnRlbnRzLmZpbHRlcigoZk5hbWUpID0+IGZzLmxzdGF0U3luYyhmTmFtZSkuaXNGaWxlKCkpO1xuXG4gIGNvbnN0IGRpcnMgPSBydWxlU2V0RGlyQ29udGVudHNcbiAgICAuZmlsdGVyKChmTmFtZSkgPT4gIWZzLmxzdGF0U3luYyhmTmFtZSkuaXNGaWxlKCkgJiYgZk5hbWUuaW5kZXhPZigndXRpbHMnKSA9PT0gLTEpO1xuXG4gIGZpbGVzLmZvckVhY2goKGZpbGUpID0+IHtcbiAgICBjb25zdCBSdWxlID0gcmVxdWlyZShmaWxlKTtcbiAgICBjb25zdCBydWxlQ29uZmlnID0gZ2V0T2JqQnlQYXRoT3JQYXJlbnQoY29uZmlnQ29weS5ydWxlcywgUnVsZS5ydWxlKSB8fCB7IGxldmVsOiA0IH07XG5cbiAgICBjb25zdCBydWxlSW5zdGFuY2UgPSBuZXcgUnVsZShydWxlQ29uZmlnKTtcbiAgICBpZiAocnVsZUNvbmZpZy5sZXZlbCAhPT0gJ29mZicpIHtcbiAgICAgIGlmICghcnVsZUluc3RhbmNlLmNvbmZpZykge1xuICAgICAgICBydWxlSW5zdGFuY2UuY29uZmlnID0gcnVsZUNvbmZpZztcbiAgICAgIH1cbiAgICAgIHJ1bGVJbnN0YW5jZS5fY29uZmlnID0gcnVsZUNvbmZpZztcbiAgICAgIHJ1bGVTZXQucHVzaChydWxlSW5zdGFuY2UpO1xuICAgIH1cbiAgICBhbGxSdWxlcy5wdXNoKHJ1bGVJbnN0YW5jZSk7XG4gIH0pO1xuXG4gIGRpcnMuZm9yRWFjaCgoZGlyKSA9PiB7XG4gICAgY29uc3QgW25lc3RlZFJ1bGVzLCBhbGxOZXN0ZWRSdWxlc10gPSBsb2FkUnVsZXNldCh7XG4gICAgICAuLi5jb25maWdDb3B5LFxuICAgICAgcnVsZXNQYXRoOiBkaXIsXG4gICAgfSk7XG4gICAgcnVsZVNldC5wdXNoKC4uLm5lc3RlZFJ1bGVzKTtcbiAgICBhbGxSdWxlcy5wdXNoKC4uLmFsbE5lc3RlZFJ1bGVzKTtcbiAgfSk7XG5cbiAgcmV0dXJuIFtydWxlU2V0LCBhbGxSdWxlc107XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2FkUnVsZXNldEV4dGVuc2lvbihjb25maWcsIHJ1bGVzZXROYW1lKSB7XG4gIGNvbnN0IGFkZGl0aW9uYWxSdWxlcyA9IFtdO1xuXG4gIGNvbnN0IGNvbmZpZ0NvcHkgPSB7XG4gICAgLi4uY29uZmlnLFxuICAgIHJ1bGVzUGF0aDogY29uZmlnLnJ1bGVzUGF0aCA/IGNvbmZpZy5ydWxlc1BhdGggOiBgJHtfX2Rpcm5hbWV9Ly4uL3Zpc2l0b3JzYCxcbiAgfTtcblxuICBjb25maWdbcnVsZXNldE5hbWVdLmZvckVhY2goKFJ1bGUpID0+IHtcbiAgICBjb25zdCBydWxlQ29uZmlnID0gZ2V0T2JqQnlQYXRoT3JQYXJlbnQoY29uZmlnQ29weS5ydWxlcywgUnVsZS5ydWxlKSB8fCB7IGxldmVsOiA0IH07XG5cbiAgICBpZiAocnVsZUNvbmZpZy5sZXZlbCAhPT0gJ29mZicpIHtcbiAgICAgIGNvbnN0IHJ1bGVJbnN0YW5jZSA9IG5ldyBSdWxlKHJ1bGVDb25maWcpO1xuICAgICAgaWYgKCFydWxlSW5zdGFuY2UuY29uZmlnKSB7XG4gICAgICAgIHJ1bGVJbnN0YW5jZS5jb25maWcgPSBydWxlQ29uZmlnO1xuICAgICAgfVxuICAgICAgcnVsZUluc3RhbmNlLl9jb25maWcgPSBydWxlQ29uZmlnO1xuICAgICAgYWRkaXRpb25hbFJ1bGVzLnB1c2gocnVsZUluc3RhbmNlKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gYWRkaXRpb25hbFJ1bGVzO1xufVxuXG5leHBvcnQgZGVmYXVsdCBsb2FkUnVsZXNldDtcbiJdfQ==