"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.fromError = exports.createErrorFlat = exports.getReferencedFrom = exports.getMsgLevelFromString = exports.messageLevels = void 0;

var _path = _interopRequireDefault(require("path"));

var _yaml = require("../yaml");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const messageLevels = {
  ERROR: 4,
  WARNING: 3,
  INFO: 2,
  DEBUG: 1
};
exports.messageLevels = messageLevels;

const getLocationForPath = (fName, nodePath, target, {
  filePath,
  source
}) => (0, _yaml.getLocationByPath)(Array.from(nodePath), {
  filePath,
  source
}, target).startLine;

const getMsgLevelFromString = severityString => {
  switch (severityString.toLowerCase()) {
    case 'debug':
      return 1;

    case 'info':
      return 2;

    case 'warning':
      return 3;

    case 'error':
    default:
      return 4;
  }
};

exports.getMsgLevelFromString = getMsgLevelFromString;

const getReferencedFrom = ctx => {
  const lastRef = ctx.pathStack[ctx.pathStack.length - 1];
  if (!lastRef) return null;
  return {
    file: _path.default.relative(process.cwd(), lastRef.file),
    startLine: getLocationForPath(lastRef.file, [...lastRef.path, '$ref'], 'key', {
      source: lastRef.source,
      filePath: lastRef.file
    }),
    path: Array.from(lastRef.path)
  };
};

exports.getReferencedFrom = getReferencedFrom;

const createError = (msg, node, ctx, options) => {
  const {
    target,
    possibleAlternate,
    fromRule
  } = options;
  let {
    severity = messageLevels.ERROR
  } = options;

  if (typeof severity === 'string') {
    severity = getMsgLevelFromString(severity);
  }

  let location = (0, _yaml.getLocationByPath)(Array.from(ctx.path), ctx, target);
  if (!location) location = (0, _yaml.getLocationByPath)(Array.from(ctx.path), ctx);
  return {
    message: msg,
    path: Array.from(ctx.path),
    referencedFrom: getReferencedFrom(ctx),
    location,
    codeFrame: ctx.enableCodeframe && location ? (0, _yaml.getCodeFrameForLocation)(location.startIndex, location.endIndex, ctx.source, location.startLine) : null,
    value: node,
    file: _path.default.relative(process.cwd(), ctx.filePath),
    severity,
    enableCodeframe: ctx.enableCodeframe,
    possibleAlternate,
    fromRule,
    target
  };
};

const createErrorFlat = (node, ctx, fromRule, severity, msg, target, possibleAlternate) => createError(msg, node, ctx, {
  target,
  fromRule,
  severity,
  possibleAlternate
});

exports.createErrorFlat = createErrorFlat;

const fromError = (error, ctx) => ( // let location = getLocationByPath(Array.from(ctx.path), ctx, error.target);
// if (!location) location = getLocationByPath(Array.from(ctx.path), ctx);
{ ...error,
  ...ctx,
  document: null,
  source: null,
  path: error.path,
  referencedFrom: getReferencedFrom(ctx)
});

exports.fromError = fromError;
var _default = createError;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lcnJvci9kZWZhdWx0LmpzIl0sIm5hbWVzIjpbIm1lc3NhZ2VMZXZlbHMiLCJFUlJPUiIsIldBUk5JTkciLCJJTkZPIiwiREVCVUciLCJnZXRMb2NhdGlvbkZvclBhdGgiLCJmTmFtZSIsIm5vZGVQYXRoIiwidGFyZ2V0IiwiZmlsZVBhdGgiLCJzb3VyY2UiLCJBcnJheSIsImZyb20iLCJzdGFydExpbmUiLCJnZXRNc2dMZXZlbEZyb21TdHJpbmciLCJzZXZlcml0eVN0cmluZyIsInRvTG93ZXJDYXNlIiwiZ2V0UmVmZXJlbmNlZEZyb20iLCJjdHgiLCJsYXN0UmVmIiwicGF0aFN0YWNrIiwibGVuZ3RoIiwiZmlsZSIsInBhdGgiLCJyZWxhdGl2ZSIsInByb2Nlc3MiLCJjd2QiLCJjcmVhdGVFcnJvciIsIm1zZyIsIm5vZGUiLCJvcHRpb25zIiwicG9zc2libGVBbHRlcm5hdGUiLCJmcm9tUnVsZSIsInNldmVyaXR5IiwibG9jYXRpb24iLCJtZXNzYWdlIiwicmVmZXJlbmNlZEZyb20iLCJjb2RlRnJhbWUiLCJlbmFibGVDb2RlZnJhbWUiLCJzdGFydEluZGV4IiwiZW5kSW5kZXgiLCJ2YWx1ZSIsImNyZWF0ZUVycm9yRmxhdCIsImZyb21FcnJvciIsImVycm9yIiwiZG9jdW1lbnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUVPLE1BQU1BLGFBQWEsR0FBRztBQUMzQkMsRUFBQUEsS0FBSyxFQUFFLENBRG9CO0FBRTNCQyxFQUFBQSxPQUFPLEVBQUUsQ0FGa0I7QUFHM0JDLEVBQUFBLElBQUksRUFBRSxDQUhxQjtBQUkzQkMsRUFBQUEsS0FBSyxFQUFFO0FBSm9CLENBQXRCOzs7QUFPUCxNQUFNQyxrQkFBa0IsR0FBRyxDQUFDQyxLQUFELEVBQVFDLFFBQVIsRUFBa0JDLE1BQWxCLEVBQTBCO0FBQUVDLEVBQUFBLFFBQUY7QUFBWUMsRUFBQUE7QUFBWixDQUExQixLQUFtRCw2QkFDNUVDLEtBQUssQ0FBQ0MsSUFBTixDQUFXTCxRQUFYLENBRDRFLEVBRTVFO0FBQUVFLEVBQUFBLFFBQUY7QUFBWUMsRUFBQUE7QUFBWixDQUY0RSxFQUc1RUYsTUFINEUsRUFJNUVLLFNBSkY7O0FBTU8sTUFBTUMscUJBQXFCLEdBQUlDLGNBQUQsSUFBb0I7QUFDdkQsVUFBUUEsY0FBYyxDQUFDQyxXQUFmLEVBQVI7QUFDRSxTQUFLLE9BQUw7QUFDRSxhQUFPLENBQVA7O0FBQ0YsU0FBSyxNQUFMO0FBQ0UsYUFBTyxDQUFQOztBQUNGLFNBQUssU0FBTDtBQUNFLGFBQU8sQ0FBUDs7QUFDRixTQUFLLE9BQUw7QUFDQTtBQUNFLGFBQU8sQ0FBUDtBQVRKO0FBV0QsQ0FaTTs7OztBQWNBLE1BQU1DLGlCQUFpQixHQUFJQyxHQUFELElBQVM7QUFDeEMsUUFBTUMsT0FBTyxHQUFHRCxHQUFHLENBQUNFLFNBQUosQ0FBY0YsR0FBRyxDQUFDRSxTQUFKLENBQWNDLE1BQWQsR0FBdUIsQ0FBckMsQ0FBaEI7QUFDQSxNQUFJLENBQUNGLE9BQUwsRUFBYyxPQUFPLElBQVA7QUFDZCxTQUFPO0FBQ0xHLElBQUFBLElBQUksRUFBRUMsY0FBS0MsUUFBTCxDQUFjQyxPQUFPLENBQUNDLEdBQVIsRUFBZCxFQUE2QlAsT0FBTyxDQUFDRyxJQUFyQyxDQUREO0FBRUxULElBQUFBLFNBQVMsRUFBRVIsa0JBQWtCLENBQzNCYyxPQUFPLENBQUNHLElBRG1CLEVBRTNCLENBQUMsR0FBR0gsT0FBTyxDQUFDSSxJQUFaLEVBQWtCLE1BQWxCLENBRjJCLEVBRzNCLEtBSDJCLEVBSTNCO0FBQUViLE1BQUFBLE1BQU0sRUFBRVMsT0FBTyxDQUFDVCxNQUFsQjtBQUEwQkQsTUFBQUEsUUFBUSxFQUFFVSxPQUFPLENBQUNHO0FBQTVDLEtBSjJCLENBRnhCO0FBUUxDLElBQUFBLElBQUksRUFBRVosS0FBSyxDQUFDQyxJQUFOLENBQVdPLE9BQU8sQ0FBQ0ksSUFBbkI7QUFSRCxHQUFQO0FBVUQsQ0FiTTs7OztBQWVQLE1BQU1JLFdBQVcsR0FBRyxDQUFDQyxHQUFELEVBQU1DLElBQU4sRUFBWVgsR0FBWixFQUFpQlksT0FBakIsS0FBNkI7QUFDL0MsUUFBTTtBQUNKdEIsSUFBQUEsTUFESTtBQUNJdUIsSUFBQUEsaUJBREo7QUFDdUJDLElBQUFBO0FBRHZCLE1BRUZGLE9BRko7QUFJQSxNQUFJO0FBQUVHLElBQUFBLFFBQVEsR0FBR2pDLGFBQWEsQ0FBQ0M7QUFBM0IsTUFBcUM2QixPQUF6Qzs7QUFFQSxNQUFJLE9BQU9HLFFBQVAsS0FBb0IsUUFBeEIsRUFBa0M7QUFDaENBLElBQUFBLFFBQVEsR0FBR25CLHFCQUFxQixDQUFDbUIsUUFBRCxDQUFoQztBQUNEOztBQUVELE1BQUlDLFFBQVEsR0FBRyw2QkFBa0J2QixLQUFLLENBQUNDLElBQU4sQ0FBV00sR0FBRyxDQUFDSyxJQUFmLENBQWxCLEVBQXdDTCxHQUF4QyxFQUE2Q1YsTUFBN0MsQ0FBZjtBQUNBLE1BQUksQ0FBQzBCLFFBQUwsRUFBZUEsUUFBUSxHQUFHLDZCQUFrQnZCLEtBQUssQ0FBQ0MsSUFBTixDQUFXTSxHQUFHLENBQUNLLElBQWYsQ0FBbEIsRUFBd0NMLEdBQXhDLENBQVg7QUFFZixTQUFPO0FBQ0xpQixJQUFBQSxPQUFPLEVBQUVQLEdBREo7QUFFTEwsSUFBQUEsSUFBSSxFQUFFWixLQUFLLENBQUNDLElBQU4sQ0FBV00sR0FBRyxDQUFDSyxJQUFmLENBRkQ7QUFHTGEsSUFBQUEsY0FBYyxFQUFFbkIsaUJBQWlCLENBQUNDLEdBQUQsQ0FINUI7QUFJTGdCLElBQUFBLFFBSks7QUFLTEcsSUFBQUEsU0FBUyxFQUFFbkIsR0FBRyxDQUFDb0IsZUFBSixJQUF1QkosUUFBdkIsR0FDUCxtQ0FDQUEsUUFBUSxDQUFDSyxVQURULEVBRUFMLFFBQVEsQ0FBQ00sUUFGVCxFQUdBdEIsR0FBRyxDQUFDUixNQUhKLEVBSUF3QixRQUFRLENBQUNyQixTQUpULENBRE8sR0FPUCxJQVpDO0FBYUw0QixJQUFBQSxLQUFLLEVBQUVaLElBYkY7QUFjTFAsSUFBQUEsSUFBSSxFQUFFQyxjQUFLQyxRQUFMLENBQWNDLE9BQU8sQ0FBQ0MsR0FBUixFQUFkLEVBQTZCUixHQUFHLENBQUNULFFBQWpDLENBZEQ7QUFlTHdCLElBQUFBLFFBZks7QUFnQkxLLElBQUFBLGVBQWUsRUFBRXBCLEdBQUcsQ0FBQ29CLGVBaEJoQjtBQWlCTFAsSUFBQUEsaUJBakJLO0FBa0JMQyxJQUFBQSxRQWxCSztBQW1CTHhCLElBQUFBO0FBbkJLLEdBQVA7QUFxQkQsQ0FuQ0Q7O0FBcUNPLE1BQU1rQyxlQUFlLEdBQUcsQ0FDN0JiLElBRDZCLEVBQ3ZCWCxHQUR1QixFQUNsQmMsUUFEa0IsRUFDUkMsUUFEUSxFQUNFTCxHQURGLEVBQ09wQixNQURQLEVBQ2V1QixpQkFEZixLQUUxQkosV0FBVyxDQUFDQyxHQUFELEVBQU1DLElBQU4sRUFBWVgsR0FBWixFQUFpQjtBQUMvQlYsRUFBQUEsTUFEK0I7QUFDdkJ3QixFQUFBQSxRQUR1QjtBQUNiQyxFQUFBQSxRQURhO0FBQ0hGLEVBQUFBO0FBREcsQ0FBakIsQ0FGVDs7OztBQU1BLE1BQU1ZLFNBQVMsR0FBRyxDQUFDQyxLQUFELEVBQVExQixHQUFSLE9BQ3ZCO0FBQ0E7QUFDQSxFQUNFLEdBQUcwQixLQURMO0FBRUUsS0FBRzFCLEdBRkw7QUFHRTJCLEVBQUFBLFFBQVEsRUFBRSxJQUhaO0FBSUVuQyxFQUFBQSxNQUFNLEVBQUUsSUFKVjtBQUtFYSxFQUFBQSxJQUFJLEVBQUVxQixLQUFLLENBQUNyQixJQUxkO0FBTUVhLEVBQUFBLGNBQWMsRUFBRW5CLGlCQUFpQixDQUFDQyxHQUFEO0FBTm5DLENBSHVCLENBQWxCOzs7ZUFhUVMsVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZ2V0TG9jYXRpb25CeVBhdGgsIGdldENvZGVGcmFtZUZvckxvY2F0aW9uIH0gZnJvbSAnLi4veWFtbCc7XG5cbmV4cG9ydCBjb25zdCBtZXNzYWdlTGV2ZWxzID0ge1xuICBFUlJPUjogNCxcbiAgV0FSTklORzogMyxcbiAgSU5GTzogMixcbiAgREVCVUc6IDEsXG59O1xuXG5jb25zdCBnZXRMb2NhdGlvbkZvclBhdGggPSAoZk5hbWUsIG5vZGVQYXRoLCB0YXJnZXQsIHsgZmlsZVBhdGgsIHNvdXJjZSB9KSA9PiBnZXRMb2NhdGlvbkJ5UGF0aChcbiAgQXJyYXkuZnJvbShub2RlUGF0aCksXG4gIHsgZmlsZVBhdGgsIHNvdXJjZSB9LFxuICB0YXJnZXQsXG4pLnN0YXJ0TGluZTtcblxuZXhwb3J0IGNvbnN0IGdldE1zZ0xldmVsRnJvbVN0cmluZyA9IChzZXZlcml0eVN0cmluZykgPT4ge1xuICBzd2l0Y2ggKHNldmVyaXR5U3RyaW5nLnRvTG93ZXJDYXNlKCkpIHtcbiAgICBjYXNlICdkZWJ1Zyc6XG4gICAgICByZXR1cm4gMTtcbiAgICBjYXNlICdpbmZvJzpcbiAgICAgIHJldHVybiAyO1xuICAgIGNhc2UgJ3dhcm5pbmcnOlxuICAgICAgcmV0dXJuIDM7XG4gICAgY2FzZSAnZXJyb3InOlxuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gNDtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGdldFJlZmVyZW5jZWRGcm9tID0gKGN0eCkgPT4ge1xuICBjb25zdCBsYXN0UmVmID0gY3R4LnBhdGhTdGFja1tjdHgucGF0aFN0YWNrLmxlbmd0aCAtIDFdO1xuICBpZiAoIWxhc3RSZWYpIHJldHVybiBudWxsO1xuICByZXR1cm4ge1xuICAgIGZpbGU6IHBhdGgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgbGFzdFJlZi5maWxlKSxcbiAgICBzdGFydExpbmU6IGdldExvY2F0aW9uRm9yUGF0aChcbiAgICAgIGxhc3RSZWYuZmlsZSxcbiAgICAgIFsuLi5sYXN0UmVmLnBhdGgsICckcmVmJ10sXG4gICAgICAna2V5JyxcbiAgICAgIHsgc291cmNlOiBsYXN0UmVmLnNvdXJjZSwgZmlsZVBhdGg6IGxhc3RSZWYuZmlsZSB9LFxuICAgICksXG4gICAgcGF0aDogQXJyYXkuZnJvbShsYXN0UmVmLnBhdGgpLFxuICB9O1xufTtcblxuY29uc3QgY3JlYXRlRXJyb3IgPSAobXNnLCBub2RlLCBjdHgsIG9wdGlvbnMpID0+IHtcbiAgY29uc3Qge1xuICAgIHRhcmdldCwgcG9zc2libGVBbHRlcm5hdGUsIGZyb21SdWxlLFxuICB9ID0gb3B0aW9ucztcblxuICBsZXQgeyBzZXZlcml0eSA9IG1lc3NhZ2VMZXZlbHMuRVJST1IgfSA9IG9wdGlvbnM7XG5cbiAgaWYgKHR5cGVvZiBzZXZlcml0eSA9PT0gJ3N0cmluZycpIHtcbiAgICBzZXZlcml0eSA9IGdldE1zZ0xldmVsRnJvbVN0cmluZyhzZXZlcml0eSk7XG4gIH1cblxuICBsZXQgbG9jYXRpb24gPSBnZXRMb2NhdGlvbkJ5UGF0aChBcnJheS5mcm9tKGN0eC5wYXRoKSwgY3R4LCB0YXJnZXQpO1xuICBpZiAoIWxvY2F0aW9uKSBsb2NhdGlvbiA9IGdldExvY2F0aW9uQnlQYXRoKEFycmF5LmZyb20oY3R4LnBhdGgpLCBjdHgpO1xuXG4gIHJldHVybiB7XG4gICAgbWVzc2FnZTogbXNnLFxuICAgIHBhdGg6IEFycmF5LmZyb20oY3R4LnBhdGgpLFxuICAgIHJlZmVyZW5jZWRGcm9tOiBnZXRSZWZlcmVuY2VkRnJvbShjdHgpLFxuICAgIGxvY2F0aW9uLFxuICAgIGNvZGVGcmFtZTogY3R4LmVuYWJsZUNvZGVmcmFtZSAmJiBsb2NhdGlvblxuICAgICAgPyBnZXRDb2RlRnJhbWVGb3JMb2NhdGlvbihcbiAgICAgICAgbG9jYXRpb24uc3RhcnRJbmRleCxcbiAgICAgICAgbG9jYXRpb24uZW5kSW5kZXgsXG4gICAgICAgIGN0eC5zb3VyY2UsXG4gICAgICAgIGxvY2F0aW9uLnN0YXJ0TGluZSxcbiAgICAgIClcbiAgICAgIDogbnVsbCxcbiAgICB2YWx1ZTogbm9kZSxcbiAgICBmaWxlOiBwYXRoLnJlbGF0aXZlKHByb2Nlc3MuY3dkKCksIGN0eC5maWxlUGF0aCksXG4gICAgc2V2ZXJpdHksXG4gICAgZW5hYmxlQ29kZWZyYW1lOiBjdHguZW5hYmxlQ29kZWZyYW1lLFxuICAgIHBvc3NpYmxlQWx0ZXJuYXRlLFxuICAgIGZyb21SdWxlLFxuICAgIHRhcmdldCxcbiAgfTtcbn07XG5cbmV4cG9ydCBjb25zdCBjcmVhdGVFcnJvckZsYXQgPSAoXG4gIG5vZGUsIGN0eCwgZnJvbVJ1bGUsIHNldmVyaXR5LCBtc2csIHRhcmdldCwgcG9zc2libGVBbHRlcm5hdGUsXG4pID0+IGNyZWF0ZUVycm9yKG1zZywgbm9kZSwgY3R4LCB7XG4gIHRhcmdldCwgZnJvbVJ1bGUsIHNldmVyaXR5LCBwb3NzaWJsZUFsdGVybmF0ZSxcbn0pO1xuXG5leHBvcnQgY29uc3QgZnJvbUVycm9yID0gKGVycm9yLCBjdHgpID0+IChcbiAgLy8gbGV0IGxvY2F0aW9uID0gZ2V0TG9jYXRpb25CeVBhdGgoQXJyYXkuZnJvbShjdHgucGF0aCksIGN0eCwgZXJyb3IudGFyZ2V0KTtcbiAgLy8gaWYgKCFsb2NhdGlvbikgbG9jYXRpb24gPSBnZXRMb2NhdGlvbkJ5UGF0aChBcnJheS5mcm9tKGN0eC5wYXRoKSwgY3R4KTtcbiAge1xuICAgIC4uLmVycm9yLFxuICAgIC4uLmN0eCxcbiAgICBkb2N1bWVudDogbnVsbCxcbiAgICBzb3VyY2U6IG51bGwsXG4gICAgcGF0aDogZXJyb3IucGF0aCxcbiAgICByZWZlcmVuY2VkRnJvbTogZ2V0UmVmZXJlbmNlZEZyb20oY3R4KSxcbiAgfVxuKTtcblxuZXhwb3J0IGRlZmF1bHQgY3JlYXRlRXJyb3I7XG4iXX0=